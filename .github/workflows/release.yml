name: "Release"
on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  pre-release-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Run pre-commit
        run: pre-commit run --all-files

      - name: Setup jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: "Install latest devcontainer CLI"
        run: npm install -g @devcontainers/cli

      - name: "Test all features"
        run: |
          features=$(./.github/scripts/get-features.sh)
          echo "Testing features: $features"
          devcontainer features test --skip-scenarios .

  deploy:
    runs-on: ubuntu-latest
    needs: pre-release-checks
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: "Publish Features"
        if: ${{ !env.ACT }}
        uses: devcontainers/action@v1
        with:
          publish-features: "true"
          base-path-to-features: "./src"
          generate-docs: "true"

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
